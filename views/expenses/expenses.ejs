<%- include('../partials/header.ejs')%>
<div class="container">
    <h2>Expenses <a href="/expenses/new" style="font-weight: bold;">+</a></h2>
</div>

<form method="GET" action="/expenses" class="filter-form">
    <input type="text" name="searchTerm" placeholder="Search by name" value="<%= typeof searchTerm !== 'undefined' ? searchTerm : '' %>" />
    <input type="text" name="category" placeholder="Category" value="<%= typeof category !== 'undefined' ? category : '' %>" />
    <input type="date" name="startDate" value="<%= typeof startDate !== 'undefined' ? startDate : '' %>" />
    <input type="date" name="endDate" value="<%= typeof endDate !== 'undefined' ? endDate : '' %>" />
    <input type="number" name="minAmount" placeholder="Min Amount" step="0.01" value="<%= typeof minAmount !== 'undefined' ? minAmount : '' %>" />
    <input type="number" name="maxAmount" placeholder="Max Amount" step="0.01" value="<%= typeof maxAmount !== 'undefined' ? maxAmount : '' %>" />
    <button type="submit">Filter</button>
</form>

<% if (expenses.length === 0) { %>
    <p style="text-align: center; font-weight: bold;">No expenses found.</p>
<% } else { %>
    <% if (user.income.incomeAmount === 0 || user.savingsAmount === 0) { %>
        <h3 style="text-align: center;">Please set a monthly income amount and savings goal in your settings menu!</h3>
    <% } else if (user.income.incomeAmount - totalExpense > 0) { %>
        <h3 style="text-align: center;">Based on your monthly income, you have $<%= user.income.incomeAmount - totalExpense %> left to spend this month</h3>
        <h3 style="text-align: center;">To achieve your savings goal of $<%= user.income.savingsAmount %> in <%= user.income.savingsDeadline %> months, you will need to save $<%= parseFloat(user.income.savingsAmount / user.income.savingsDeadline).toFixed(2) %> each month</h3>
        <% if ((user.income.incomeAmount - totalExpense) - parseFloat(user.income.savingsAmount / user.income.savingsDeadline).toFixed(2) > 0) { %>
            <h3 style="text-align: center;">Based on your savings goals and remaining income, you have $<%= parseFloat((user.income.incomeAmount - totalExpense) - parseFloat(user.income.savingsAmount / user.income.savingsDeadline).toFixed(2)).toFixed(2) %> left to spend this month</h3>
        <% } else { %>
            <h3 style="text-align: center;">Based on your savings goals and remaining income, your balance is lower than your monthly savings budget.</h3>
        <% } %>
    <% } else { %>
        <h3 style="text-align: center;">Based on your monthly income, you have spent more than your alloted monthly income by $<%= -(user.income.incomeAmount - totalExpense) %></h3>
        <h3 style="text-align: center;">It is impossible to save for your goal this month given your remaining balance</h3>
    <% } %>

    <table class="expenses-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Amount</th>
                <th>Category</th>
                <th>Date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <% expenses.forEach(expense => { %>
                <tr>
                    <td><%= expense.name || "N/A" %></td>
                    <td>$<%= expense.amount || "0.00" %></td>
                    <td><%= expense.category || "Uncategorized" %></td>
                    <td><%= expense.date ? new Date(expense.date).toLocaleDateString() : "N/A" %></td>
                    <td>
                        <div class="action-buttons">
                        <a href="/expenses/<%= expense._id %>" class="view-btn">View</a> |
                        <a href="/expenses/<%= expense._id %>/edit" class="edit-btn">Edit</a> |
                        <form action="/expenses/<%= expense._id %>?_method=DELETE" method="POST" style="display:inline;">
                            <button type="submit" onclick="return confirm('Are you sure you want to delete this expense?');">Delete</button>
                        </form>
                    </div>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
<% } %>

<script>
    if (window.location.search.includes("refresh=true")) {
        window.location.href = "/expenses";
    }
</script>

</div>

<% include('../partials/footer.ejs') %>

